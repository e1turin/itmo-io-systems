# Лабораторная работа 2

**Название:** "Разработка драйверов блочных устройств"

**Цель работы:** 

> получить знания и навыки разработки драйверов блочных устройств для
> операционной системы Linux.

## Описание функциональности драйвера

Драйвер в соответствии с заданием варианта создает виртуальный диск в
оперативной памяти и создает в нем разделы MBR. При попытке записать на диск
данные заполняются в соответствии с «полезной» функицей.

> Один первичный раздел размером 20Мбайт и один расширенный раздел, содержащий
> два логических раздела размером 17Мбайт и 13Мбайт.
>
> Каждый последующий байт должен быть результатом умножения предыдущих.

## Инструкция по сборке

Для сборки модуля ядра из исходного кода нужно в директории `lab-2/driver/`
выполнить цель по умолчанию для `make`, при этом требуется права
суперпользователя:

```shell 
sudo make 
```

После успешной компиляции в той же директории должен появиться файл
`blk_drv.ko`.

Для очистки каталога от временных файлов:

```shell
make clean
```

## Инструкция пользователя

Для загрузки модуля нужно выполнить соответствующую команду с правами
администратора:

```shell
sudo insmod blk_drv.ko
```

Проверить загрузку модуля можно с помощью команд:

```sudo 
lsmod | grep blk_drv
```

Для выгрузки модуля нужно выполнить соответствующую команду с правами
администратора:

```shell
sudo rmmod blk_drv
```

Модуль создает файл блочного устройства `vramdrive` в каталоге `/dev/`, в который
можно записывать и читать текстовые данные.

## Инструкция пользователя

Просмотр созданных разделов можно выполнить с помощью команды

```shell
sudo fdisk -l /dev/vramdisk
```

Пример результата выполнения команды:

```
Disk /dev/vramdisk: 50 MiB, 52428800 bytes, 102400 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x36e5756d

Device         Boot Start    End Sectors Size Id Type
/dev/vramdisk1          1  40959   40959  20M 83 Linux
/dev/vramdisk2      40960 102399   61440  30M  5 Extended
/dev/vramdisk5      40961  75775   34815  17M 83 Linux
/dev/vramdisk6      75777 102399   26623  13M 83 Linux
```

Измерение скорости записи c помощью составленного скрипта:

```shell
sudo bash bench.sh
```

```text
root@dev-3:/mnt/io-systems/lab-2/driver# bash bench.sh
Filling virt disk with random data
9+0 records in
9+0 records out
9437184 bytes (9.4 MB, 9.0 MiB) copied, 0.166837 s, 56.6 MB/s
From virt disk to virt disk
9+0 records in
9+0 records out
9437184 bytes (9.4 MB, 9.0 MiB) copied, 0.147865 s, 63.8 MB/s
From virt disk to phys disk
9+0 records in
9+0 records out
9437184 bytes (9.4 MB, 9.0 MiB) copied, 0.0391396 s, 241 MB/s
```


## Примеры использования

Заполнение нулями:

```text
root@dev-3:/mnt/io-systems/lab-2/driver# dd if=/dev/zero of=/dev/vramdisk5 bs=1M count=9
9+0 records in
9+0 records out
9437184 bytes (9.4 MB, 9.0 MiB) copied, 0.123233 s, 76.6 MB/s
root@dev-3:/mnt/io-systems/lab-2/driver# xxd /dev/vramdisk5 | head
00000000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
```

Заполнение случайными значениями:

```text
root@dev-3:/mnt/io-systems/lab-2/driver# dd if=/dev/random of=/dev/vramdisk5 bs=1M count=9
9+0 records in
9+0 records out
9437184 bytes (9.4 MB, 9.0 MiB) copied, 0.175332 s, 53.8 MB/s
root@dev-3:/mnt/io-systems/lab-2/driver# xxd /dev/vramdisk5 | head
00000000: 4000 0000 0000 0000 0000 0000 0000 0000  @...............
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
```

Ввод из консоли:

```text
root@dev-3:/mnt/io-systems/lab-2/driver# cat > /dev/vramdisk5
abc
root@dev-3:/mnt/io-systems/lab-2/driver# xxd /dev/vramdisk5 | head
00000000: c181 0101 0101 0101 0101 0101 0101 0101  ................
00000010: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000020: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000030: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000040: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000050: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000060: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000070: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000080: 0101 0101 0101 0101 0101 0101 0101 0101  ................
00000090: 0101 0101 0101 0101 0101 0101 0101 0101  ................
```
